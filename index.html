<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="å…è´¹åœ¨çº¿å¾®ä¿¡è¡¨æƒ…åŒ…åˆ¶ä½œç¥å™¨ï¼Œä¸€é”®åˆ¶ä½œ240x240æ ‡å‡†è¡¨æƒ…ï¼ŒMP4è§†é¢‘è½¬GIFåŠ¨æ€è¡¨æƒ…ï¼Œä¹å®«æ ¼/åå…­å®«æ ¼åˆ‡å›¾ã€‚æ”¯æŒæ™ºèƒ½å‹ç¼©è‡³500KBä»¥ä¸‹ï¼Œå®Œç¾é€‚é…å¾®ä¿¡è¡¨æƒ…å¼€æ”¾å¹³å°è§„èŒƒã€‚çº¯å‰ç«¯å¤„ç†ï¼Œä¿æŠ¤éšç§ã€‚">
    <meta name="keywords" content="å¾®ä¿¡è¡¨æƒ…åŒ…åˆ¶ä½œ, è§†é¢‘è½¬GIF, åœ¨çº¿GIFå‹ç¼©, ä¹å®«æ ¼åˆ‡å›¾, å¾®ä¿¡è¡¨æƒ…å°ºå¯¸, åŠ¨æ€è¡¨æƒ…åˆ¶ä½œ, è¡¨æƒ…åŒ…è½¬æ¢å™¨, æœ‹å‹åœˆåˆ‡å›¾, å¾®ä¿¡æ–—å›¾å·¥å…·">
    <title>å¾®ä¿¡è¡¨æƒ…åŒ…åˆ¶ä½œç¥å™¨ - è§†é¢‘è½¬GIF/ä¹å®«æ ¼åˆ‡å›¾/è‡ªåŠ¨å‹ç¼© (å…è´¹åœ¨çº¿)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8108749186774450"
     crossorigin="anonymous"></script>

    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input[type=range] { height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: currentColor; margin-top: -5px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px; }
        
        /* é’ˆå¯¹ SEO å†…å®¹çš„æ ·å¼ä¼˜åŒ– - å¢å¼ºå¯è¯»æ€§ï¼Œè®© Google è®¤ä¸ºè¿™æ˜¯é«˜è´¨é‡æ–‡ç«  */
        .seo-content { line-height: 1.8; color: #4b5563; }
        .seo-content h2 { font-size: 1.8rem; font-weight: 800; margin-top: 3rem; margin-bottom: 1.5rem; color: #1f2937; letter-spacing: -0.025em; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        .seo-content h3 { font-size: 1.4rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1rem; color: #374151; }
        .seo-content p { margin-bottom: 1.5rem; font-size: 1rem; }
        .seo-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1.5rem; }
        .seo-content ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1.5rem; }
        .seo-content li { margin-bottom: 0.5rem; }
        .seo-content strong { color: #111827; font-weight: 600; }
        .seo-content .highlight-box { background-color: #f3f4f6; border-left: 4px solid #3b82f6; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.25rem; }

        /* èƒŒæ™¯æ¼‚æµ®åŠ¨ç”» */
        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-20vh) rotate(360deg); opacity: 0; }
        }
        .floating-emoji {
            position: absolute;
            bottom: -50px;
            animation: floatUp linear infinite;
            user-select: none;
            z-index: -1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans relative overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            ImageIcon: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>,
            VideoIcon: (p) => <IconBase {...p}><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></IconBase>,
            GridIcon: (p) => <IconBase {...p}><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></IconBase>,
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            FileImage: (p) => <IconBase {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><circle cx="10" cy="10" r="2"/><path d="m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22"/></IconBase>,
            Wand2: (p) => <IconBase {...p}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></IconBase>,
            Package: (p) => <IconBase {...p}><path d="m16.5 9.4-9-5.19"/><path d="m21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></IconBase>,
            Sliders: (p) => <IconBase {...p}><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="2" x2="6" y1="14" y2="14"/><line x1="10" x2="14" y1="8" y2="8"/><line x1="18" x2="22" y1="16" y2="16"/></IconBase>,
            Heart: (p) => <IconBase {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>,
            UserPlus: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/></IconBase>,
            Palette: (p) => <IconBase {...p}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconBase>,
            Compress: (p) => <IconBase {...p}><path d="M11 5v6h6"/><path d="M5 19v-6h6"/><path d="m19 5-8 8"/><path d="m5 19 8-8"/></IconBase>,
            Shield: (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>
        };

        // --- å¹¿å‘Šç»„ä»¶ ---
        const AdUnit = ({ slot, format = "auto" }) => {
            useEffect(() => {
                try {
                    if (window.adsbygoogle) {
                        (window.adsbygoogle = window.adsbygoogle || []).push({});
                    }
                } catch (e) { }
            }, []);

            return (
                <div className="w-full my-4 flex justify-center bg-gray-50 rounded-lg overflow-hidden min-h-[100px] border border-dashed border-gray-200 relative">
                    <ins className="adsbygoogle"
                         style={{ display: 'block', width: '100%' }}
                         data-ad-client="ca-pub-8108749186774450"
                         data-ad-slot={slot || "1234567890"}
                         data-ad-format={format}
                         data-full-width-responsive="true"></ins>
                    <div className="absolute inset-0 flex items-center justify-center text-gray-300 text-xs pointer-events-none">
                        å¹¿å‘Šä½ (ç­‰å¾…åŠ è½½)
                    </div>
                </div>
            );
        };

        // --- éšç§æ”¿ç­–å¼¹çª—ç»„ä»¶ (AdSense å¿…é¡») ---
        const PrivacyModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl max-w-lg w-full p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icons.Shield size={20} className="text-green-500"/>éšç§æƒæ”¿ç­–</h2>
                    <div className="text-sm text-gray-600 space-y-3">
                        <p><strong>1. æ•°æ®æ”¶é›†ä¸éšç§ï¼š</strong> æœ¬å·¥å…·ï¼ˆå¾®ä¿¡è¡¨æƒ…åŒ…åˆ¶ä½œç¥å™¨ï¼‰è‡´åŠ›äºä¿æŠ¤æ‚¨çš„éšç§ã€‚æ‰€æœ‰å›¾ç‰‡ã€è§†é¢‘å’Œå¤„ç†è¿‡ç¨‹å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ï¼ˆClient-sideï¼‰å®Œæˆï¼Œæˆ‘ä»¬ç»å¯¹ä¸ä¼šå°†æ‚¨çš„æ–‡ä»¶ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚æ‚¨çš„åˆ›ä½œå†…å®¹ä»…ä¿å­˜åœ¨æ‚¨çš„è®¾å¤‡ä¸Šã€‚</p>
                        <p><strong>2. Cookies ä¸å¹¿å‘Šï¼š</strong> ä¸ºäº†ç»´æŒç½‘ç«™è¿è¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ Google AdSense å±•ç¤ºå¹¿å‘Šã€‚Google ä½œä¸ºç¬¬ä¸‰æ–¹ä¾›åº”å•†ï¼Œå¯èƒ½ä¼šä½¿ç”¨ Cookiesï¼ˆå¦‚ DoubleClick Cookieï¼‰æ¥æ ¹æ®æ‚¨è®¿é—®æœ¬ç½‘ç«™å’Œå…¶ä»–ç½‘ç«™çš„è®°å½•å±•ç¤ºä¸ªæ€§åŒ–å¹¿å‘Šã€‚</p>
                        <p><strong>3. æ‚¨çš„æƒåˆ©ï¼š</strong> æ‚¨å¯ä»¥é€šè¿‡è®¿é—® <a href="http://www.google.com/ads/preferences/" target="_blank" class="text-blue-500 underline">Google å¹¿å‘Šè®¾ç½®</a> æ¥é€‰æ‹©åœç”¨ä¸ªæ€§åŒ–å¹¿å‘Šã€‚</p>
                        <p><strong>4. å…è´£å£°æ˜ï¼š</strong> æœ¬å·¥å…·å…è´¹æä¾›ï¼Œä¸é™„å¸¦ä»»ä½•æ˜ç¤ºæˆ–æš—ç¤ºçš„ä¿è¯ã€‚å¯¹äºå› ä½¿ç”¨æœ¬å·¥å…·è€Œé€ æˆçš„ä»»ä½•æ•°æ®ä¸¢å¤±æˆ–å…¶ä»–æŸå¤±ï¼Œæˆ‘ä»¬ä¸æ‰¿æ‹…è´£ä»»ã€‚</p>
                    </div>
                    <button onClick={onClose} className="w-full mt-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold transition-colors">æˆ‘å·²çŸ¥æ™“</button>
                </div>
            </div>
        );

        // --- èƒŒæ™¯åŠ¨æ•ˆç»„ä»¶ ---
        const BackgroundEffects = () => {
            const emojis = useMemo(() => {
                const list = ['ğŸ˜‚', 'ğŸ˜', 'ğŸ”¥', 'ğŸ¤”', 'ğŸ‘€', 'ğŸ’–', 'ğŸ‰', 'âœ¨', 'ğŸ¥º', 'ğŸ±', 'ğŸš€', 'ğŸŒˆ', 'ğŸ’©', 'ğŸ‘»', 'ğŸ¤–'];
                return Array.from({ length: 25 }).map((_, i) => ({
                    id: i,
                    char: list[Math.floor(Math.random() * list.length)],
                    left: `${Math.random() * 100}%`,
                    animationDuration: `${15 + Math.random() * 20}s`,
                    animationDelay: `${Math.random() * 10}s`,
                    fontSize: `${16 + Math.random() * 24}px`
                }));
            }, []);

            return (
                <div className="fixed inset-0 pointer-events-none overflow-hidden -z-10">
                    {emojis.map(e => (
                        <div 
                            key={e.id}
                            className="floating-emoji text-gray-300 opacity-20"
                            style={{
                                left: e.left,
                                animationDuration: e.animationDuration,
                                animationDelay: e.animationDelay,
                                fontSize: e.fontSize
                            }}
                        >
                            {e.char}
                        </div>
                    ))}
                </div>
            );
        };

        const App = () => {
            const [items, setItems] = useState([]);
            const [mode, setMode] = useState('static'); 
            const [showPrivacy, setShowPrivacy] = useState(false);
            
            // è®¾ç½®çŠ¶æ€
            const [targetSize, setTargetSize] = useState({ w: 240, h: 240 });
            const [quality, setQuality] = useState(0.9);
            const [paddingColor, setPaddingColor] = useState('transparent');
            const [removeWhiteBg, setRemoveWhiteBg] = useState(false);
            const [bgTolerance, setBgTolerance] = useState(20);
            
            // åˆ‡ç‰‡ç‹¬ç«‹é…ç½®
            const [sliceRows, setSliceRows] = useState(3);
            const [sliceCols, setSliceCols] = useState(3);
            
            // GIF ç‹¬ç«‹é…ç½®
            const [gifConfig, setGifConfig] = useState({
                fps: 8,
                quality: 10,
                duration: 3
            });

            const [isGlobalProcessing, setIsGlobalProcessing] = useState(false);
            const [isZipping, setIsZipping] = useState(false);
            const [clearConfirm, setClearConfirm] = useState(false);
            const [workerBlobUrl, setWorkerBlobUrl] = useState(null);

            useEffect(() => {
                const fetchWorker = async () => {
                    try {
                        const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                        const text = await response.text();
                        const blob = new Blob([text], { type: 'application/javascript' });
                        setWorkerBlobUrl(URL.createObjectURL(blob));
                    } catch (e) {
                        console.error("Failed to load gif worker", e);
                    }
                };
                fetchWorker();
            }, []);

            const sizePresets = [
                { w: 240, h: 240, label: '240x240 (æ ‡å‡†)' },
                { w: 50, h: 50, label: '50x50 (å›¾æ ‡)' },
                { w: 750, h: 400, label: '750x400 (æ¨ªå¹…)' },
                { w: 300, h: 300, label: '300x300' },
            ];

            const generateId = () => Math.random().toString(36).substr(2, 9);

            // ... (çœç•¥éƒ¨åˆ†æœªå˜åŠ¨çš„åˆ‡å›¾é€»è¾‘ï¼Œç›´æ¥ä¿ç•™åŸæœ‰é€»è¾‘ç»“æ„)
            const processSliceImage = async (file) => {
                return new Promise((resolve) => {
                    const imgUrl = URL.createObjectURL(file);
                    const img = new Image();
                    img.src = imgUrl;
                    img.onload = () => {
                        const size = Math.max(img.width, img.height);
                        const offsetX = (size - img.width) / 2;
                        const offsetY = (size - img.height) / 2;
                        const rows = sliceRows;
                        const cols = sliceCols;
                        const pieceW = size / cols;
                        const pieceH = size / rows;
                        const newItems = [];
                        for (let row = 0; row < rows; row++) {
                            for (let col = 0; col < cols; col++) {
                                const index = row * cols + col + 1;
                                newItems.push({
                                    id: generateId(),
                                    file: null,
                                    originalUrl: imgUrl, 
                                    processedUrl: null,
                                    size: 0,
                                    status: 'pending',
                                    name: `${file.name.replace(/\.[^/.]+$/, "")}_${index}.png`,
                                    type: 'image',
                                    sliceInfo: { cellX: col * pieceW, cellY: row * pieceH, cellSizeW: pieceW, cellSizeH: pieceH, imgX: offsetX, imgY: offsetY, imgW: img.width, imgH: img.height }
                                });
                            }
                        }
                        resolve(newItems);
                    };
                });
            };

            const processSliceVideo = async (file) => {
                return new Promise((resolve) => {
                    const videoUrl = URL.createObjectURL(file);
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.src = videoUrl;
                    video.muted = true;
                    video.onloadedmetadata = () => {
                        const size = Math.max(video.videoWidth, video.videoHeight);
                        const offsetX = (size - video.videoWidth) / 2;
                        const offsetY = (size - video.videoHeight) / 2;
                        const rows = sliceRows;
                        const cols = sliceCols;
                        const pieceW = size / cols;
                        const pieceH = size / rows;
                        const newItems = [];
                        for (let i = 0; i < rows * cols; i++) {
                            const row = Math.floor(i / cols);
                            const col = i % cols;
                            newItems.push({
                                id: generateId(),
                                file: file,
                                originalUrl: videoUrl,
                                processedUrl: null,
                                size: 0,
                                status: 'pending',
                                name: `${file.name.replace(/\.[^/.]+$/, "")}_${i+1}.gif`,
                                type: 'video',
                                sliceInfo: { cellX: col * pieceW, cellY: row * pieceH, cellSizeW: pieceW, cellSizeH: pieceH, videoX: offsetX, videoY: offsetY, videoW: video.videoWidth, videoH: video.videoHeight }
                            });
                        }
                        resolve(newItems);
                    };
                });
            };

            const addFiles = async (files) => {
                if (mode === 'slice') {
                    setIsGlobalProcessing(true);
                    const validFiles = Array.from(files).filter(f => f.type.match('image.*') || f.type.match('video.*'));
                    if (validFiles.length === 0) {
                        alert('è¯·ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶');
                        setIsGlobalProcessing(false);
                        return;
                    }
                    const allNewItems = [];
                    for (const file of validFiles) {
                        if (file.type.match('image.*')) {
                            const slices = await processSliceImage(file);
                            allNewItems.push(...slices);
                        } else if (file.type.match('video.*')) {
                            const slices = await processSliceVideo(file);
                            allNewItems.push(...slices);
                        }
                    }
                    setItems(prev => [...prev, ...allNewItems]);
                    setIsGlobalProcessing(false);
                    return;
                }
                const newItems = Array.from(files)
                .filter(file => {
                    if (mode === 'static') return file.type.match('image.*');
                    if (mode === 'dynamic') return file.type.match('video.*');
                    return false;
                })
                .map(file => ({
                    id: generateId(),
                    file,
                    originalUrl: URL.createObjectURL(file), 
                    processedUrl: null,
                    size: 0,
                    status: 'pending',
                    name: file.name,
                    type: mode === 'dynamic' ? 'video' : 'image'
                }));
                if (newItems.length === 0) {
                    if (files.length > 0) alert(mode === 'static' ? 'è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶' : 'è¯·ä¸Šä¼ è§†é¢‘æ–‡ä»¶');
                    return;
                }
                setItems(prev => [...prev, ...newItems]);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                if (e.dataTransfer.files) addFiles(e.dataTransfer.files);
            };

            // ... (DrawFrame logic unchanged) ...
            const drawFrame = (ctx, source, width, height, color, removeBg, tolerance, sliceInfo) => {
                ctx.clearRect(0, 0, width, height);
                if (color !== 'transparent') {
                    ctx.fillStyle = color;
                    ctx.fillRect(0, 0, width, height);
                }
                if (sliceInfo) {
                    const scale = width / sliceInfo.cellSizeW;
                    const dx = ( (sliceInfo.imgX ?? sliceInfo.videoX) - sliceInfo.cellX ) * scale;
                    const dy = ( (sliceInfo.imgY ?? sliceInfo.videoY) - sliceInfo.cellY ) * scale;
                    const dw = (sliceInfo.imgW ?? sliceInfo.videoW) * scale;
                    const dh = (sliceInfo.imgH ?? sliceInfo.videoH) * scale;
                    ctx.drawImage(source, dx, dy, dw, dh);
                } else {
                    const srcW = source.videoWidth || source.width;
                    const srcH = source.videoHeight || source.height;
                    const scale = Math.min(width / srcW, height / srcH);
                    const w = srcW * scale;
                    const h = srcH * scale;
                    const x = (width - w) / 2;
                    const y = (height - h) / 2;
                    ctx.drawImage(source, x, y, w, h);
                }
                if (removeBg) {
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    const tol = tolerance || 20;
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        if (r > 255 - tol && g > 255 - tol && b > 255 - tol) {
                            data[i + 3] = 0;
                        }
                    }
                    ctx.putImageData(imageData, 0, 0);
                }
            };

            const processItem = useCallback(async (item, width, height, color, q, removeBg, tolerance, workerUrl, currentGifConfig) => {
                if (!item.originalUrl || item.status === 'done') return item; 
                if (item.type === 'video') {
                    if (!workerUrl) return { ...item, status: 'error' };
                    return new Promise((resolve) => {
                        const video = document.createElement('video');
                        video.src = item.originalUrl;
                        video.muted = true;
                        video.crossOrigin = "anonymous";
                        video.onloadedmetadata = () => {
                            const fps = currentGifConfig.fps;
                            const maxDuration = currentGifConfig.duration;
                            const gifQuality = currentGifConfig.quality;
                            const duration = Math.min(video.duration, maxDuration);
                            const interval = 1 / fps;
                            let currentTime = 0;
                            const gif = new GIF({
                                workers: 2,
                                quality: gifQuality,
                                width: width,
                                height: height,
                                workerScript: workerUrl,
                                repeat: 0,
                                background: color === 'transparent' ? 0x00000000 : null,
                                transparent: color === 'transparent' ? 0x00000000 : null
                            });
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            const captureFrame = () => {
                                if (currentTime > duration) {
                                    gif.render();
                                    return;
                                }
                                video.currentTime = currentTime;
                            };
                            video.onseeked = () => {
                                drawFrame(ctx, video, width, height, color, removeBg, tolerance, item.sliceInfo);
                                gif.addFrame(ctx, {copy: true, delay: interval * 1000});
                                currentTime += interval;
                                captureFrame();
                            };
                            gif.on('finished', (blob) => {
                                resolve({
                                    ...item,
                                    processedUrl: URL.createObjectURL(blob),
                                    size: blob.size,
                                    status: 'done',
                                    name: item.name.endsWith('.gif') ? item.name : item.name.replace(/\.[^/.]+$/, "") + ".gif"
                                });
                            });
                            captureFrame();
                        };
                        video.onerror = () => resolve({ ...item, status: 'error' });
                    });
                }
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = item.originalUrl;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        drawFrame(ctx, img, width, height, color, removeBg, tolerance, item.sliceInfo);
                        canvas.toBlob((blob) => {
                            resolve({
                                ...item,
                                processedUrl: URL.createObjectURL(blob),
                                size: blob.size,
                                status: 'done',
                                name: item.name.replace(/\.[^/.]+$/, "") + ".png"
                            });
                        }, 'image/png', q);
                    };
                    img.onerror = () => resolve({ ...item, status: 'error' });
                });
            }, []);

            useEffect(() => {
                const processQueue = async () => {
                    const itemsToProcess = items.filter(item => item.originalUrl && item.status === 'pending');
                    if (itemsToProcess.length > 0) {
                        setIsGlobalProcessing(true);
                        const processedResults = await Promise.all(
                            itemsToProcess.map(item => processItem(
                                item, 
                                targetSize.w, 
                                targetSize.h, 
                                paddingColor, 
                                quality, 
                                removeWhiteBg, 
                                bgTolerance, 
                                workerBlobUrl, 
                                item.customConfig || gifConfig 
                            ))
                        );
                        setItems(prev => prev.map(prevItem => {
                            const processed = processedResults.find(p => p.id === prevItem.id);
                            return processed || prevItem;
                        }));
                        setIsGlobalProcessing(false);
                    }
                };
                processQueue();
            }, [items, targetSize, paddingColor, quality, removeWhiteBg, bgTolerance, workerBlobUrl, processItem, gifConfig]);

            useEffect(() => {
                setItems(prev => prev.map(item => ({ ...item, status: 'pending', customConfig: null }))); 
            }, [targetSize, paddingColor, quality, removeWhiteBg, bgTolerance, workerBlobUrl, gifConfig]);

            const formatSize = (bytes) => {
                if (bytes === 0) return '...';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            const removeItem = (id) => setItems(prev => prev.filter(item => item.id !== id));

            const removeAll = () => {
                if (clearConfirm) {
                    setItems([]);
                    setClearConfirm(false);
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput) fileInput.value = '';
                } else {
                    setClearConfirm(true);
                    setTimeout(() => setClearConfirm(false), 3000);
                }
            };

            const compressItem = (id) => {
                setItems(prev => prev.map(item => {
                    if (item.id === id) {
                        return {
                            ...item,
                            status: 'pending', 
                            customConfig: {
                                fps: 5,       
                                duration: 2.0,
                                quality: 20   
                            }
                        };
                    }
                    return item;
                }));
            };

            const downloadItem = (item) => {
                if (!item.processedUrl) return;
                const link = document.createElement('a');
                link.href = item.processedUrl;
                link.download = item.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const downloadAllZip = async () => {
                if (!window.JSZip) return alert("ç»„ä»¶åŠ è½½ä¸­...");
                setIsZipping(true);
                const zip = new JSZip();
                const folder = zip.folder("stickers");
                let count = 0;
                for (const item of items) {
                    if (item.processedUrl) {
                        try {
                            const response = await fetch(item.processedUrl);
                            const blob = await response.blob();
                            folder.file(item.name, blob);
                            count++;
                        } catch (e) { console.error(e); }
                    }
                }
                if (count > 0) {
                    const content = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = "stickers.zip";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                setIsZipping(false);
            };

            const themeColor = mode === 'static' ? 'green' : (mode === 'dynamic' ? 'purple' : 'blue');
            const themeIconBg = mode === 'static' ? 'bg-green-100 text-green-600' : (mode === 'dynamic' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600');
            const themeBorderHover = `hover:border-${themeColor}-400 hover:bg-${themeColor}-50`;

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans p-4 md:p-8">
                <BackgroundEffects />
                
                <div className="max-w-6xl mx-auto">
                    <header className="mb-8 text-center">
                        <h1 className="text-3xl font-bold text-gray-900 mb-2">å…¨èƒ½è¡¨æƒ…åŒ…å·¥å‚</h1>
                        <p className="text-gray-500">å¿«é€Ÿåˆ¶ä½œå¾®ä¿¡è¡¨æƒ…åŒ… Â· æœ¬åœ°å¤„ç†ä¿æŠ¤éšç§</p>
                    </header>

                    {/* Mode Switcher */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        {['static', 'dynamic', 'slice'].map(m => (
                            <button 
                                key={m}
                                onClick={() => { setMode(m); setRemoveWhiteBg(false); setItems([]); }} 
                                className={`p-4 rounded-3xl border-2 transition-all duration-300 flex items-center justify-center gap-3 group ${mode === m 
                                    ? `border-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-500 bg-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-50 text-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-700 shadow-md ring-2 ring-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-500 ring-offset-2` 
                                    : 'border-gray-200 bg-white text-gray-500 hover:border-gray-300 hover:bg-gray-50'}`}
                            >
                                <div className={`p-2 rounded-full ${mode === m ? `bg-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-200` : 'bg-gray-100'}`}>
                                    {m === 'static' && <Icons.ImageIcon size={24} />}
                                    {m === 'dynamic' && <Icons.VideoIcon size={24} />}
                                    {m === 'slice' && <Icons.GridIcon size={24} />}
                                </div>
                                <div className="text-left">
                                    <div className="font-bold text-base">
                                        {m === 'static' ? 'é™æ€è¡¨æƒ…' : m === 'dynamic' ? 'åŠ¨æ€è¡¨æƒ…' : 'åˆ‡å›¾(3x3/4x4)'}
                                    </div>
                                    <div className="text-[10px] opacity-70">
                                        {m === 'static' ? 'JPG / PNG' : m === 'dynamic' ? 'è§†é¢‘è½¬GIF' : 'å›¾ç‰‡/è§†é¢‘ åˆ‡å‰²'}
                                    </div>
                                </div>
                            </button>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* å·¦ä¾§æ§åˆ¶åŒº */}
                        <div className="lg:col-span-4 space-y-6">
                            <div 
                                className={`border-4 border-dashed rounded-3xl bg-white p-8 text-center transition-all cursor-pointer group shadow-sm relative overflow-hidden border-gray-200 ${themeBorderHover}`}
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={handleDrop}
                                onClick={() => document.getElementById('fileInput').click()}
                            >
                                <input 
                                    type="file" 
                                    id="fileInput" 
                                    className="hidden" 
                                    accept={mode === 'static' ? "image/*" : (mode === 'dynamic' ? "video/*" : "image/*,video/*")} 
                                    multiple 
                                    onChange={(e) => {if(e.target.files) addFiles(e.target.files); e.target.value='';}} 
                                />
                                <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform ${themeIconBg}`}>
                                    {mode === 'static' && <Icons.Plus size={32} />}
                                    {mode === 'dynamic' && <Icons.VideoIcon size={32} />}
                                    {mode === 'slice' && <Icons.GridIcon size={32} />}
                                </div>
                                <h3 className="text-lg font-semibold text-gray-700 mb-1">
                                    {mode === 'slice' ? 'ç‚¹å‡»æ·»åŠ ç´ æ(å›¾/è§†é¢‘)' : `ç‚¹å‡»æ·»åŠ ${mode === 'static' ? 'å›¾ç‰‡' : 'è§†é¢‘'}`}
                                </h3>
                                <p className="text-gray-400 text-xs">
                                    {mode === 'static' ? 'æ”¯æŒæ‰¹é‡ JPG, PNG, WEBP' : mode === 'dynamic' ? 'æ”¯æŒ MP4, MOV' : 'è‡ªåŠ¨è£å‰ªæ­£æ–¹å½¢å¹¶åˆ‡å›¾'}
                                </p>
                            </div>

                            <div className="bg-white rounded-3xl shadow-sm border border-gray-100 p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><Icons.Settings size={20} className="text-gray-400" />å‚æ•°è®¾ç½®</h3>
                                </div>
                                <div className="space-y-6">
                                    
                                    {mode === 'slice' && (
                                        <div className="p-4 rounded-xl bg-blue-50 border border-blue-100">
                                            <div className="flex justify-between items-center mb-3">
                                                <div className="flex items-center gap-2 text-blue-800">
                                                    <Icons.GridIcon size={16} />
                                                    <h4 className="font-bold text-sm">è‡ªå®šä¹‰åˆ‡ç‰‡ç½‘æ ¼</h4>
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => { setSliceRows(3); setSliceCols(3); }} className={`text-[10px] px-2 py-1 border rounded transition-colors ${sliceRows===3 && sliceCols===3 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-blue-600 border-blue-200 hover:bg-blue-50'}`}>3x3</button>
                                                    <button onClick={() => { setSliceRows(4); setSliceCols(4); }} className={`text-[10px] px-2 py-1 border rounded transition-colors ${sliceRows===4 && sliceCols===4 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-blue-600 border-blue-200 hover:bg-blue-50'}`}>4x4</button>
                                                </div>
                                            </div>
                                            <div className="space-y-4">
                                                <div className="space-y-1">
                                                    <div className="flex justify-between text-xs text-gray-500"><span>è¡Œæ•° (Rows)</span><span className="font-mono font-bold text-blue-600">{sliceRows}</span></div>
                                                    <input type="range" min="1" max="8" step="1" value={sliceRows} onChange={(e) => setSliceRows(parseInt(e.target.value))} className="w-full h-1 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                                </div>
                                                <div className="space-y-1">
                                                    <div className="flex justify-between text-xs text-gray-500"><span>åˆ—æ•° (Cols)</span><span className="font-mono font-bold text-blue-600">{sliceCols}</span></div>
                                                    <input type="range" min="1" max="8" step="1" value={sliceCols} onChange={(e) => setSliceCols(parseInt(e.target.value))} className="w-full h-1 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                                </div>
                                                <div className="text-[10px] text-blue-400 text-center pt-1 border-t border-blue-100">å°†ç”Ÿæˆ {sliceRows * sliceCols} ä¸ªæ–‡ä»¶</div>
                                            </div>
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-sm font-medium text-gray-600 mb-2">ç›®æ ‡å°ºå¯¸ (å•å¼ )</label>
                                        <div className="flex flex-wrap gap-2">
                                            {sizePresets.map(preset => (
                                                <button key={preset.label} onClick={() => setTargetSize({ w: preset.w, h: preset.h })} className={`py-2 px-3 rounded-xl text-xs font-medium border transition-all ${targetSize.w === preset.w && targetSize.h === preset.h ? `bg-${themeColor}-500 text-white border-${themeColor}-500 shadow-md` : 'bg-white text-gray-600 border-gray-200 hover:border-gray-300'}`}>{preset.label}</button>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-600 mb-2">èƒŒæ™¯å¤„ç†</label>
                                        <div className="flex gap-2 mb-3">
                                            <button onClick={() => setPaddingColor('transparent')} className={`flex-1 py-2 rounded-xl text-xs font-medium border flex items-center justify-center gap-2 ${paddingColor === 'transparent' ? `ring-2 ring-${themeColor}-500 border-${themeColor}-500 bg-${themeColor}-50 text-${themeColor}-700` : 'border-gray-200'}`}><div className="w-3 h-3 rounded border bg-gray-100" style={{backgroundImage: 'linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)', backgroundSize: '4px 4px'}}></div>é€æ˜</button>
                                            <button onClick={() => setPaddingColor('white')} className={`flex-1 py-2 rounded-xl text-xs font-medium border flex items-center justify-center gap-2 ${paddingColor === 'white' ? `ring-2 ring-${themeColor}-500 border-${themeColor}-500 bg-white text-gray-900` : 'border-gray-200'}`}><div className="w-3 h-3 rounded border border-gray-300 bg-white"></div>ç™½è‰²</button>
                                            <label className={`flex-1 py-2 rounded-xl text-xs font-medium border flex items-center justify-center gap-2 cursor-pointer ${paddingColor !== 'transparent' && paddingColor !== 'white' ? `ring-2 ring-${themeColor}-500 border-${themeColor}-500 bg-white text-gray-900` : 'border-gray-200'}`}>
                                                <input type="color" className="opacity-0 w-0 h-0 absolute" value={paddingColor === 'transparent' ? '#ffffff' : paddingColor} onChange={(e) => setPaddingColor(e.target.value)} />
                                                <div className="w-3 h-3 rounded border border-gray-300" style={{backgroundColor: paddingColor !== 'transparent' ? paddingColor : 'transparent'}}></div>
                                                <span className="flex items-center gap-1"><Icons.Palette size={12}/>è‡ªå®šä¹‰</span>
                                            </label>
                                        </div>

                                        <div className={`p-3 rounded-xl border transition-colors ${removeWhiteBg ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-transparent'}`}>
                                            <div className="flex items-center justify-between">
                                                <label className="flex items-center gap-2 cursor-pointer select-none">
                                                    <div className={`w-5 h-5 rounded border flex items-center justify-center ${removeWhiteBg ? 'bg-blue-500 border-blue-500' : 'bg-white border-gray-300'}`}>{removeWhiteBg && <Icons.CheckCircle size={14} className="text-white" />}</div>
                                                    <input type="checkbox" className="hidden" checked={removeWhiteBg} onChange={(e) => setRemoveWhiteBg(e.target.checked)} />
                                                    <span className={`text-sm font-medium ${removeWhiteBg ? 'text-blue-700' : 'text-gray-600'}`}>å»é™¤ç™½è‰²èƒŒæ™¯</span>
                                                </label>
                                                <Icons.Wand2 size={16} className={`${removeWhiteBg ? 'text-blue-500' : 'text-gray-400'}`} />
                                            </div>
                                            {removeWhiteBg && (
                                                <div className="mt-2 pt-2 border-t border-blue-100">
                                                    <div className="flex justify-between text-xs text-blue-600 mb-1"><span>å¼ºåº¦:å¼±</span><span>å¼º</span></div>
                                                    <input type="range" min="1" max="100" value={bgTolerance} onChange={(e) => setBgTolerance(parseInt(e.target.value))} className="w-full h-1.5 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {(mode === 'dynamic' || mode === 'slice') && (
                                        <div className="space-y-4 p-4 rounded-xl bg-purple-50 border border-purple-100">
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-2 text-purple-800">
                                                    <Icons.Sliders size={16} />
                                                    <h4 className="font-bold text-sm">GIF å‹ç¼©è®¾ç½®</h4>
                                                </div>
                                                <div className="flex gap-1.5">
                                                    <button onClick={() => setGifConfig({fps: 8, quality: 10, duration: 3})} className={`text-[10px] px-2 py-1 border rounded transition-colors ${gifConfig.fps===8 ? 'bg-purple-600 text-white border-purple-600' : 'bg-white border-purple-200 text-purple-600'}`}>æ ‡å‡†</button>
                                                    <button onClick={() => setGifConfig({fps: 5, quality: 10, duration: 3})} className={`text-[10px] px-2 py-1 border rounded transition-colors ${gifConfig.fps===5 ? 'bg-purple-600 text-white border-purple-600' : 'bg-white border-purple-200 text-purple-600'}`}>500Ké™åˆ¶</button>
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-xs text-gray-500"><span>å¸§ç‡</span><span className="text-purple-700">{gifConfig.fps} FPS</span></div>
                                                <input type="range" min="1" max="15" value={gifConfig.fps} onChange={(e) => setGifConfig({...gifConfig, fps: parseInt(e.target.value)})} className="w-full h-1 bg-purple-200 rounded-lg accent-purple-500" />
                                                <div className="flex justify-between text-xs text-gray-500"><span>æ—¶é•¿</span><span className="text-purple-700">{gifConfig.duration}s</span></div>
                                                <input type="range" min="1" max="10" step="0.5" value={gifConfig.duration} onChange={(e) => setGifConfig({...gifConfig, duration: parseFloat(e.target.value)})} className="w-full h-1 bg-purple-200 rounded-lg accent-purple-500" />
                                            </div>
                                        </div>
                                    )}

                                    {items.length > 0 && (
                                        <div className="pt-4 border-t border-gray-100 space-y-3">
                                            <button onClick={downloadAllZip} disabled={isZipping} className={`w-full py-3 text-white rounded-xl font-bold shadow-md active:scale-95 transition-all flex items-center justify-center gap-2 ${isZipping ? 'bg-gray-400' : `bg-${themeColor}-600 hover:bg-${themeColor}-700`}`}>
                                                {isZipping ? <Icons.RefreshCw className="animate-spin" size={18}/> : <Icons.Package size={18} />}
                                                {isZipping ? 'æ­£åœ¨æ‰“åŒ…...' : `æ‰“åŒ…ä¸‹è½½å…¨éƒ¨ (${items.length})`}
                                            </button>
                                            <button onClick={removeAll} className={`w-full py-2 rounded-xl text-sm font-medium flex items-center justify-center gap-2 transition-colors ${clearConfirm ? 'bg-red-500 text-white' : 'text-red-500 hover:bg-red-50'}`}>
                                                <Icons.Trash2 size={16} />{clearConfirm ? 'ç¡®å®šæ¸…ç©ºï¼Ÿ' : 'æ¸…ç©ºåˆ—è¡¨'}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* å·¦ä¾§å¹¿å‘Šä½ */}
                            <AdUnit slot="9876543210" />
                        </div>

                        {/* å³ä¾§ç»“æœåŒº */}
                        <div className="lg:col-span-8">
                            <div className="bg-white rounded-3xl shadow-lg border border-gray-100 p-6 min-h-[500px]">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className={`font-bold text-gray-800 flex items-center gap-2`}><Icons.FileImage size={20} className={`text-${themeColor}-500`}/>å¤„ç†ç»“æœ ({items.length})</h3>
                                    {isGlobalProcessing && <span className={`text-sm flex items-center gap-2 animate-pulse text-${themeColor}-600`}><Icons.RefreshCw size={14} className="animate-spin"/>å¤„ç†ä¸­...</span>}
                                </div>

                                {items.length > 0 ? (
                                    <div 
                                        className="grid gap-4"
                                        style={{ gridTemplateColumns: mode === 'slice' ? `repeat(${sliceCols}, minmax(0, 1fr))` : 'repeat(auto-fill, minmax(140px, 1fr))' }}
                                    >
                                        {items.map(item => (
                                            <div key={item.id} className="relative group bg-gray-50 rounded-xl border border-gray-200 p-3 hover:shadow-md transition-shadow">
                                                <button onClick={() => removeItem(item.id)} className="absolute top-2 right-2 z-10 p-1.5 bg-white text-gray-400 hover:text-red-500 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"><Icons.X size={14} /></button>
                                                <div className="bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPgo8cmVjdCB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSI0IiBoZWlnaHQ9IjQiIGZpbGw9IiNlNWU1ZTUiLz4KPHJlY3QgeD0iNCIgeT0iNCIgd2lkdGg9IjQiIGhlaWdodD0iNCIgZmlsbD0iI2U1ZTVlNSIvPgo8L3N2Zz4=')] rounded-lg overflow-hidden flex items-center justify-center mb-3 border border-gray-100 relative" style={{ aspectRatio: `${targetSize.w}/${targetSize.h}` }}>
                                                    {item.processedUrl ? (
                                                        <img src={item.processedUrl} alt="processed" className="max-w-full max-h-full object-contain" />
                                                    ) : (
                                                        <div className="flex flex-col items-center">
                                                            <Icons.RefreshCw className="animate-spin text-gray-400 mb-2" />
                                                            <span className="text-xs text-gray-400">{item.type==='video'?'è½¬æ¢ä¸­...':'å¤„ç†ä¸­...'}</span>
                                                        </div>
                                                    )}
                                                    {/* GIF/Video Badges and Overlay Buttons */}
                                                    {item.type === 'video' && item.processedUrl && (
                                                        <>
                                                            <div className="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-1 rounded">GIF</div>
                                                            {/* Smart Compress Button if size > 500KB */}
                                                            {item.size > 500 * 1024 && (
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); compressItem(item.id); }}
                                                                    className="absolute top-1 left-1 bg-red-500 hover:bg-red-600 text-white text-[10px] px-2 py-1 rounded shadow-sm flex items-center gap-1 transition-colors"
                                                                    title="æ–‡ä»¶è¿‡å¤§ï¼Œç‚¹å‡»ä¸€é”®ä¼˜åŒ–åˆ° 500KB ä»¥ä¸‹"
                                                                >
                                                                    <Icons.Compress size={10} />
                                                                    å‹ç¼©
                                                                </button>
                                                            )}
                                                        </>
                                                    )}
                                                    {mode === 'slice' && item.name.match(/_(\d+)\.(png|gif)$/) && (
                                                        <div className="absolute top-1 left-1 bg-blue-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold shadow-sm">
                                                            {item.name.match(/_(\d+)\.(png|gif)$/)[1]}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="space-y-1">
                                                    <div className="flex justify-between items-center text-xs text-gray-500">
                                                        <span className="truncate max-w-[80px]" title={item.name}>{item.name}</span>
                                                        <span className={`${item.size > 500 * 1024 ? 'text-red-500 font-bold' : `text-${themeColor}-600`}`}>{formatSize(item.size)}</span>
                                                    </div>
                                                    <button onClick={() => downloadItem(item)} disabled={!item.processedUrl} className="w-full mt-2 py-1.5 bg-white border border-gray-200 hover:border-green-500 hover:text-green-600 text-gray-600 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1"><Icons.Download size={12} />ä¸‹è½½</button>
                                                </div>
                                            </div>
                                        ))}
                                        {/* ç»§ç»­æ·»åŠ æŒ‰é’®ï¼šéåˆ‡å›¾æ¨¡å¼æ˜¾ç¤ºç»§ç»­æ·»åŠ ï¼Œåˆ‡å›¾æ¨¡å¼ä¸‹åœ¨ç©ºçŠ¶æ€æ˜¾ç¤ºç½‘æ ¼å ä½ */}
                                        {mode !== 'slice' && (
                                            <div onClick={() => document.getElementById('fileInput').click()} className={`border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-400 transition-colors cursor-pointer min-h-[160px] hover:bg-gray-50 hover:border-${themeColor}-400 hover:text-${themeColor}-500`}><Icons.Plus size={24} className="mb-2" /><span className="text-sm font-medium">ç»§ç»­æ·»åŠ </span></div>
                                        )}
                                    </div>
                                ) : (
                                    /* Empty State */
                                    mode === 'slice' ? (
                                        <div className="h-full flex flex-col items-center justify-center p-8 text-gray-300 border-2 border-dashed border-gray-100 rounded-2xl min-h-[500px]">
                                             <div 
                                                className="grid gap-2 w-full max-w-md aspect-square"
                                                style={{ 
                                                    gridTemplateColumns: `repeat(${sliceCols}, minmax(0, 1fr))`,
                                                    gridTemplateRows: `repeat(${sliceRows}, minmax(0, 1fr))`
                                                }}
                                             >
                                                {Array.from({ length: sliceRows * sliceCols }).map((_, i) => (
                                                    <div 
                                                        key={i} 
                                                        onClick={() => document.getElementById('fileInput').click()}
                                                        className="border-2 border-dashed border-gray-200 rounded-lg bg-gray-50 flex items-center justify-center hover:border-blue-400 hover:bg-blue-50 transition-colors cursor-pointer"
                                                    >
                                                        <span className="text-xs text-gray-300 font-mono">{i + 1}</span>
                                                    </div>
                                                ))}
                                             </div>
                                             <p className="text-sm mt-6 text-gray-400">ç‚¹å‡»ä»»æ„æ ¼å­ä¸Šä¼ ç´ æï¼Œè‡ªåŠ¨åˆ‡åˆ†ä¸º {sliceRows}x{sliceCols}</p>
                                        </div>
                                    ) : (
                                        <div className="h-64 flex flex-col items-center justify-center text-gray-300 border-2 border-dashed border-gray-100 rounded-2xl">
                                            <p className="text-sm">æš‚æ— ç´ æï¼Œè¯·åœ¨å·¦ä¾§æ·»åŠ </p>
                                        </div>
                                    )
                                )}
                            </div>
                        </div>
                    </div>

                    {/* SEO ä¼˜åŒ–æ–‡æœ¬åŒºåŸŸ */}
                    <article className="mt-16 pt-12 border-t border-gray-200 max-w-4xl mx-auto seo-content">
                        <h2>å…³äºå…¨èƒ½è¡¨æƒ…åŒ…åˆ¶ä½œç¥å™¨</h2>
                        <p>æ¬¢è¿ä½¿ç”¨æˆ‘ä»¬çš„åœ¨çº¿è¡¨æƒ…åŒ…å¤„ç†å·¥å…·ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œå…¨å…è´¹ã€çº¯å‰ç«¯ï¼ˆæœ¬åœ°è¿è¡Œï¼‰çš„å›¾ç‰‡å’Œè§†é¢‘å¤„ç†å¹³å°ï¼Œæ—¨åœ¨å¸®åŠ©æ‚¨è½»æ¾åˆ¶ä½œç¬¦åˆå¾®ä¿¡è¡¨æƒ…å¼€æ”¾å¹³å°æ ‡å‡†çš„è¡¨æƒ…åŒ…ç´ æã€‚æ— è®ºæ‚¨æ˜¯ä¸“ä¸šçš„è¡¨æƒ…åŒ…è®¾è®¡å¸ˆï¼Œè¿˜æ˜¯æƒ³åˆ¶ä½œæœ‰è¶£ç¾¤èŠæ–—å›¾çš„æ™®é€šç”¨æˆ·ï¼Œè¿™é‡Œéƒ½èƒ½æ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚</p>
                        
                        <h3>ä¸»è¦åŠŸèƒ½ç‰¹è‰²</h3>
                        <ul>
                            <li><strong>æ™ºèƒ½å°ºå¯¸è°ƒæ•´ï¼š</strong>ä¸€é”®å°†å›¾ç‰‡è°ƒæ•´ä¸ºå¾®ä¿¡æ ‡å‡†çš„ 240x240ã€120x120 æˆ– 750x400 åƒç´ ï¼Œè‡ªåŠ¨å±…ä¸­å¹¶å¡«å……é€æ˜æˆ–ç™½è‰²èƒŒæ™¯ï¼Œæ— éœ€å¤æ‚çš„ PS æ“ä½œã€‚</li>
                            <li><strong>è§†é¢‘è½¬åŠ¨æ€è¡¨æƒ… (GIF)ï¼š</strong>æ”¯æŒ MP4ã€MOV ç­‰æ ¼å¼è§†é¢‘ç›´æ¥è½¬æ¢ä¸º GIF åŠ¨å›¾ã€‚ç‹¬å®¶ç®—æ³•è‡ªåŠ¨ä¼˜åŒ–å¸§ç‡å’Œç”»è´¨ï¼Œæ”¯æŒä¸€é”®å‹ç¼©è‡³ 500KB ä»¥ä¸‹ï¼Œå®Œç¾é€‚é…å¾®ä¿¡æ·»åŠ é™åˆ¶ã€‚</li>
                            <li><strong>ä¹å®«æ ¼åˆ‡å›¾ï¼š</strong>æ”¯æŒå°†ä¸€å¼ å¤§å›¾æˆ–ä¸€æ®µè§†é¢‘è‡ªåŠ¨åˆ‡å‰²ä¸º 3x3 (ä¹å®«æ ¼) æˆ– 4x4 (åå…­å®«æ ¼)ï¼Œæœ‹å‹åœˆå‘å›¾æˆ–ç¾¤èŠåˆ·å±çš„ç¥å™¨ã€‚è§†é¢‘ä¹Ÿèƒ½åˆ‡æˆåŒæ­¥çš„ 9 ä¸ª GIF å“¦ï¼</li>
                            <li><strong>éšç§å®‰å…¨ä¿æŠ¤ï¼š</strong>æœ¬å·¥å…·æ‰€æœ‰å¤„ç†å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œä¸ä¼šå°†æ‚¨çš„åŸå›¾æˆ–è§†é¢‘ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ï¼Œç»å¯¹ä¿éšœæ‚¨çš„ç´ æéšç§å®‰å…¨ã€‚</li>
                        </ul>

                        <h3>å¸¸è§é—®é¢˜ (FAQ)</h3>
                        <p><strong>Q: ç”Ÿæˆçš„ GIF å¤ªå¤§æ— æ³•æ·»åŠ åˆ°å¾®ä¿¡æ€ä¹ˆåŠï¼Ÿ</strong><br/>A: è¯·ä½¿ç”¨æˆ‘ä»¬ç‰¹æœ‰çš„â€œä¸€é”®å‹ç¼©â€åŠŸèƒ½ã€‚åœ¨åŠ¨æ€è¡¨æƒ…æ¨¡å¼ä¸‹ï¼Œå¦‚æœç»“æœè¶…è¿‡ 500KBï¼Œå›¾ç‰‡å·¦ä¸Šè§’ä¼šå‡ºç°çº¢è‰²çš„å‹ç¼©æŒ‰é’®ï¼Œç‚¹å‡»å³å¯è‡ªåŠ¨ä¼˜åŒ–å‚æ•°ã€‚</p>
                        <p><strong>Q: åˆ‡å›¾æ¨¡å¼æ”¯æŒè‡ªå®šä¹‰è¡Œåˆ—å—ï¼Ÿ</strong><br/>A: æ”¯æŒã€‚åœ¨â€œä¹å®«æ ¼åˆ‡å›¾â€æ¨¡å¼ä¸‹ï¼Œæ‚¨å¯ä»¥è‡ªç”±æ‹–åŠ¨æ»‘å—è®¾ç½® 1x1 åˆ° 8x8 çš„ä»»æ„ç½‘æ ¼å¸ƒå±€ï¼Œå³ä¾§é¢„è§ˆåŒºä¼šå®æ—¶æ˜¾ç¤ºåˆ‡å‰²æ•ˆæœã€‚</p>
                    </article>

                    <footer className="mt-16 pt-8 border-t border-gray-200">
                        {/* åº•éƒ¨å¹¿å‘Šä½ */}
                        <AdUnit slot="1234567890" format="horizontal" />
                        
                        <div className="flex flex-col md:flex-row justify-center items-center gap-8 text-center md:text-left mt-8">
                            <div className="flex flex-col items-center gap-2">
                                <div className="w-32 h-32 bg-white rounded-xl flex items-center justify-center border border-gray-200 overflow-hidden shadow-sm">
                                    <img src="add.png" alt="æ·»åŠ ä½œè€…" className="w-full h-full object-contain" onError={(e) => { e.target.style.display = 'none'; e.target.parentNode.classList.add('bg-gray-50'); e.target.parentNode.innerHTML = '<div class="flex flex-col items-center gap-1 text-gray-300"><span class="text-[10px]">add.png</span></div>'; }} />
                                </div>
                                <span className="text-sm font-bold text-gray-600 flex items-center gap-1"><Icons.UserPlus size={14} className="text-blue-500"/> æ·»åŠ ä½œè€…</span>
                            </div>
                        </div>
                        <div className="mt-8 text-center text-gray-400 text-xs">
                            <p>æœ¬å·¥å…·çº¯å‰ç«¯è¿è¡Œï¼Œæ‚¨çš„å›¾ç‰‡ä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</p>
                            <p className="mt-2">
                                <button onClick={() => setShowPrivacy(true)} className="hover:text-blue-500 underline">éšç§æƒæ”¿ç­–</button>
                            </p>
                        </div>
                    </footer>

                    {showPrivacy && <PrivacyModal onClose={() => setShowPrivacy(false)} />}
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
