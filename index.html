<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信表情包/视频转GIF/九宫格切图工具</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input[type=range] { height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: currentColor; margin-top: -5px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- 图标组件 ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            ImageIcon: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>,
            VideoIcon: (p) => <IconBase {...p}><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></IconBase>,
            GridIcon: (p) => <IconBase {...p}><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></IconBase>,
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            FileImage: (p) => <IconBase {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><circle cx="10" cy="10" r="2"/><path d="m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22"/></IconBase>,
            Wand2: (p) => <IconBase {...p}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></IconBase>,
            Package: (p) => <IconBase {...p}><path d="m16.5 9.4-9-5.19"/><path d="m21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></IconBase>,
            Sliders: (p) => <IconBase {...p}><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="2" x2="6" y1="14" y2="14"/><line x1="10" x2="14" y1="8" y2="8"/><line x1="18" x2="22" y1="16" y2="16"/></IconBase>,
            Heart: (p) => <IconBase {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>,
            UserPlus: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/></IconBase>,
            Palette: (p) => <IconBase {...p}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconBase>,
            Compress: (p) => <IconBase {...p}><path d="M11 5v6h6"/><path d="M5 19v-6h6"/><path d="m19 5-8 8"/><path d="m5 19 8-8"/></IconBase>
        };

        const App = () => {
            const [items, setItems] = useState([]);
            const [mode, setMode] = useState('static'); // 'static' | 'dynamic' | 'slice'
            
            // 设置状态
            const [targetSize, setTargetSize] = useState({ w: 240, h: 240 });
            const [quality, setQuality] = useState(0.9);
            const [paddingColor, setPaddingColor] = useState('transparent');
            const [removeWhiteBg, setRemoveWhiteBg] = useState(false);
            const [bgTolerance, setBgTolerance] = useState(20);
            
            // 切片独立配置 (行与列)
            const [sliceRows, setSliceRows] = useState(3);
            const [sliceCols, setSliceCols] = useState(3);
            
            // GIF 独立配置
            const [gifConfig, setGifConfig] = useState({
                fps: 8,
                quality: 10,
                duration: 3
            });

            const [isGlobalProcessing, setIsGlobalProcessing] = useState(false);
            const [isZipping, setIsZipping] = useState(false);
            const [clearConfirm, setClearConfirm] = useState(false);
            const [workerBlobUrl, setWorkerBlobUrl] = useState(null);

            // 初始化：加载 gif.js 的 worker
            useEffect(() => {
                const fetchWorker = async () => {
                    try {
                        const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                        const text = await response.text();
                        const blob = new Blob([text], { type: 'application/javascript' });
                        setWorkerBlobUrl(URL.createObjectURL(blob));
                    } catch (e) {
                        console.error("Failed to load gif worker", e);
                    }
                };
                fetchWorker();
            }, []);

            const sizePresets = [
                { w: 240, h: 240, label: '240x240 (标准)' },
                { w: 50, h: 50, label: '50x50 (图标)' },
                { w: 750, h: 400, label: '750x400 (横幅)' },
                { w: 300, h: 300, label: '300x300' },
            ];

            const generateId = () => Math.random().toString(36).substr(2, 9);

            // --- 切图预处理 ---
            const processSliceImage = async (file) => {
                return new Promise((resolve) => {
                    const imgUrl = URL.createObjectURL(file);
                    const img = new Image();
                    img.src = imgUrl;
                    img.onload = () => {
                        const size = Math.max(img.width, img.height);
                        const offsetX = (size - img.width) / 2;
                        const offsetY = (size - img.height) / 2;
                        
                        const rows = sliceRows;
                        const cols = sliceCols;
                        const pieceW = size / cols;
                        const pieceH = size / rows;
                        const newItems = [];
                        
                        for (let row = 0; row < rows; row++) {
                            for (let col = 0; col < cols; col++) {
                                const index = row * cols + col + 1;
                                newItems.push({
                                    id: generateId(),
                                    file: null,
                                    originalUrl: imgUrl, 
                                    processedUrl: null,
                                    size: 0,
                                    status: 'pending',
                                    name: `${file.name.replace(/\.[^/.]+$/, "")}_${index}.png`,
                                    type: 'image',
                                    sliceInfo: { 
                                        cellX: col * pieceW,
                                        cellY: row * pieceH,
                                        cellSizeW: pieceW,
                                        cellSizeH: pieceH,
                                        imgX: offsetX,
                                        imgY: offsetY,
                                        imgW: img.width,
                                        imgH: img.height
                                    }
                                });
                            }
                        }
                        resolve(newItems);
                    };
                });
            };

            const processSliceVideo = async (file) => {
                return new Promise((resolve) => {
                    const videoUrl = URL.createObjectURL(file);
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.src = videoUrl;
                    video.muted = true;
                    
                    video.onloadedmetadata = () => {
                        const size = Math.max(video.videoWidth, video.videoHeight);
                        const offsetX = (size - video.videoWidth) / 2;
                        const offsetY = (size - video.videoHeight) / 2;
                        
                        const rows = sliceRows;
                        const cols = sliceCols;
                        const pieceW = size / cols;
                        const pieceH = size / rows;
                        
                        const newItems = [];
                        for (let i = 0; i < rows * cols; i++) {
                            const row = Math.floor(i / cols);
                            const col = i % cols;
                            newItems.push({
                                id: generateId(),
                                file: file,
                                originalUrl: videoUrl,
                                processedUrl: null,
                                size: 0,
                                status: 'pending',
                                name: `${file.name.replace(/\.[^/.]+$/, "")}_${i+1}.gif`,
                                type: 'video',
                                sliceInfo: {
                                    cellX: col * pieceW,
                                    cellY: row * pieceH,
                                    cellSizeW: pieceW,
                                    cellSizeH: pieceH,
                                    videoX: offsetX,
                                    videoY: offsetY,
                                    videoW: video.videoWidth,
                                    videoH: video.videoHeight
                                }
                            });
                        }
                        resolve(newItems);
                    };
                });
            };

            const addFiles = async (files) => {
                if (mode === 'slice') {
                    setIsGlobalProcessing(true);
                    const validFiles = Array.from(files).filter(f => f.type.match('image.*') || f.type.match('video.*'));
                    if (validFiles.length === 0) {
                        alert('请上传图片或视频文件');
                        setIsGlobalProcessing(false);
                        return;
                    }
                    const allNewItems = [];
                    for (const file of validFiles) {
                        if (file.type.match('image.*')) {
                            const slices = await processSliceImage(file);
                            allNewItems.push(...slices);
                        } else if (file.type.match('video.*')) {
                            const slices = await processSliceVideo(file);
                            allNewItems.push(...slices);
                        }
                    }
                    setItems(prev => [...prev, ...allNewItems]);
                    setIsGlobalProcessing(false);
                    return;
                }

                const newItems = Array.from(files)
                .filter(file => {
                    if (mode === 'static') return file.type.match('image.*');
                    if (mode === 'dynamic') return file.type.match('video.*');
                    return false;
                })
                .map(file => ({
                    id: generateId(),
                    file,
                    originalUrl: URL.createObjectURL(file), 
                    processedUrl: null,
                    size: 0,
                    status: 'pending',
                    name: file.name,
                    type: mode === 'dynamic' ? 'video' : 'image'
                }));

                if (newItems.length === 0) {
                    if (files.length > 0) alert(mode === 'static' ? '请上传图片文件' : '请上传视频文件');
                    return;
                }
                setItems(prev => [...prev, ...newItems]);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                if (e.dataTransfer.files) addFiles(e.dataTransfer.files);
            };

            // --- 核心绘制逻辑 ---
            const drawFrame = (ctx, source, width, height, color, removeBg, tolerance, sliceInfo) => {
                ctx.clearRect(0, 0, width, height);
                if (color !== 'transparent') {
                    ctx.fillStyle = color;
                    ctx.fillRect(0, 0, width, height);
                }

                if (sliceInfo) {
                    const scale = width / sliceInfo.cellSizeW;
                    const dx = ( (sliceInfo.imgX ?? sliceInfo.videoX) - sliceInfo.cellX ) * scale;
                    const dy = ( (sliceInfo.imgY ?? sliceInfo.videoY) - sliceInfo.cellY ) * scale;
                    const dw = (sliceInfo.imgW ?? sliceInfo.videoW) * scale;
                    const dh = (sliceInfo.imgH ?? sliceInfo.videoH) * scale;
                    ctx.drawImage(source, dx, dy, dw, dh);
                } else {
                    const srcW = source.videoWidth || source.width;
                    const srcH = source.videoHeight || source.height;
                    const scale = Math.min(width / srcW, height / srcH);
                    const w = srcW * scale;
                    const h = srcH * scale;
                    const x = (width - w) / 2;
                    const y = (height - h) / 2;
                    ctx.drawImage(source, x, y, w, h);
                }

                if (removeBg) {
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    const tol = tolerance || 20;
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        if (r > 255 - tol && g > 255 - tol && b > 255 - tol) {
                            data[i + 3] = 0;
                        }
                    }
                    ctx.putImageData(imageData, 0, 0);
                }
            };

            // 核心处理函数 (接收 customConfig 参数)
            const processItem = useCallback(async (item, width, height, color, q, removeBg, tolerance, workerUrl, currentGifConfig) => {
                if (!item.originalUrl || item.status === 'done') return item; 

                // --- 视频处理 ---
                if (item.type === 'video') {
                    if (!workerUrl) return { ...item, status: 'error' };
                    return new Promise((resolve) => {
                        const video = document.createElement('video');
                        video.src = item.originalUrl;
                        video.muted = true;
                        video.crossOrigin = "anonymous";
                        
                        video.onloadedmetadata = () => {
                            const fps = currentGifConfig.fps;
                            const maxDuration = currentGifConfig.duration;
                            const gifQuality = currentGifConfig.quality;
                            const duration = Math.min(video.duration, maxDuration);
                            const interval = 1 / fps;
                            let currentTime = 0;

                            const gif = new GIF({
                                workers: 2,
                                quality: gifQuality,
                                width: width,
                                height: height,
                                workerScript: workerUrl,
                                repeat: 0,
                                background: color === 'transparent' ? 0x00000000 : null,
                                transparent: color === 'transparent' ? 0x00000000 : null
                            });

                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');

                            const captureFrame = () => {
                                if (currentTime > duration) {
                                    gif.render();
                                    return;
                                }
                                video.currentTime = currentTime;
                            };

                            video.onseeked = () => {
                                drawFrame(ctx, video, width, height, color, removeBg, tolerance, item.sliceInfo);
                                gif.addFrame(ctx, {copy: true, delay: interval * 1000});
                                currentTime += interval;
                                captureFrame();
                            };

                            gif.on('finished', (blob) => {
                                resolve({
                                    ...item,
                                    processedUrl: URL.createObjectURL(blob),
                                    size: blob.size,
                                    status: 'done',
                                    name: item.name.endsWith('.gif') ? item.name : item.name.replace(/\.[^/.]+$/, "") + ".gif"
                                });
                            });
                            captureFrame();
                        };
                        video.onerror = () => resolve({ ...item, status: 'error' });
                    });
                }

                // --- 图片处理 ---
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = item.originalUrl;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        drawFrame(ctx, img, width, height, color, removeBg, tolerance, item.sliceInfo);

                        canvas.toBlob((blob) => {
                            resolve({
                                ...item,
                                processedUrl: URL.createObjectURL(blob),
                                size: blob.size,
                                status: 'done',
                                name: item.name.replace(/\.[^/.]+$/, "") + ".png"
                            });
                        }, 'image/png', q);
                    };
                    img.onerror = () => resolve({ ...item, status: 'error' });
                });
            }, []);

            // 批量处理队列
            useEffect(() => {
                const processQueue = async () => {
                    const itemsToProcess = items.filter(item => item.originalUrl && item.status === 'pending');
                    if (itemsToProcess.length > 0) {
                        setIsGlobalProcessing(true);
                        const processedResults = await Promise.all(
                            itemsToProcess.map(item => processItem(
                                item, 
                                targetSize.w, 
                                targetSize.h, 
                                paddingColor, 
                                quality, 
                                removeWhiteBg, 
                                bgTolerance, 
                                workerBlobUrl, 
                                item.customConfig || gifConfig // 优先使用单独的压缩配置
                            ))
                        );
                        setItems(prev => prev.map(prevItem => {
                            const processed = processedResults.find(p => p.id === prevItem.id);
                            return processed || prevItem;
                        }));
                        setIsGlobalProcessing(false);
                    }
                };
                processQueue();
            }, [items, targetSize, paddingColor, quality, removeWhiteBg, bgTolerance, workerBlobUrl, processItem, gifConfig]);

            useEffect(() => {
                // 当全局设置改变时，所有非slice模式的图片重置，slice模式下保持不变以免切片错乱，
                // 或者我们可以让全部重置。简单起见，只要有变动就重置所有非 'done' 的？
                // 为了响应“背景色”改变，我们需要重置状态。
                // 注意：如果点击了单独压缩，customConfig 会被设置，这里全局变更会覆盖它吗？
                // 现在的逻辑：全局变动 -> 所有变为 pending -> 重新生成。
                // 如果想保留单独压缩的结果，需要 diff 逻辑。
                // 简单处理：全局变动重置所有。
                setItems(prev => prev.map(item => ({ ...item, status: 'pending', customConfig: null }))); 
            }, [targetSize, paddingColor, quality, removeWhiteBg, bgTolerance, workerBlobUrl, gifConfig]);

            const formatSize = (bytes) => {
                if (bytes === 0) return '...';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            const removeItem = (id) => setItems(prev => prev.filter(item => item.id !== id));

            const removeAll = () => {
                if (clearConfirm) {
                    setItems([]);
                    setClearConfirm(false);
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput) fileInput.value = '';
                } else {
                    setClearConfirm(true);
                    setTimeout(() => setClearConfirm(false), 3000);
                }
            };

            // --- 智能压缩处理 ---
            const compressItem = (id) => {
                setItems(prev => prev.map(item => {
                    if (item.id === id) {
                        return {
                            ...item,
                            status: 'pending', // 触发重新处理
                            customConfig: {
                                fps: 5,       // 降帧
                                duration: 2.0,// 缩短时长
                                quality: 20   // 降低画质
                            }
                        };
                    }
                    return item;
                }));
            };

            const downloadItem = (item) => {
                if (!item.processedUrl) return;
                const link = document.createElement('a');
                link.href = item.processedUrl;
                link.download = item.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const downloadAllZip = async () => {
                if (!window.JSZip) return alert("组件加载中...");
                setIsZipping(true);
                const zip = new JSZip();
                const folder = zip.folder("stickers");
                let count = 0;
                for (const item of items) {
                    if (item.processedUrl) {
                        try {
                            const response = await fetch(item.processedUrl);
                            const blob = await response.blob();
                            folder.file(item.name, blob);
                            count++;
                        } catch (e) { console.error(e); }
                    }
                }
                if (count > 0) {
                    const content = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = "stickers.zip";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                setIsZipping(false);
            };

            const themeColor = mode === 'static' ? 'green' : (mode === 'dynamic' ? 'purple' : 'blue');
            const themeIconBg = mode === 'static' ? 'bg-green-100 text-green-600' : (mode === 'dynamic' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600');
            const themeBorderHover = `hover:border-${themeColor}-400 hover:bg-${themeColor}-50`;

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans p-4 md:p-8">
                <div className="max-w-6xl mx-auto">
                    <header className="mb-8 text-center">
                        <h1 className="text-3xl font-bold text-gray-900 mb-2">全能表情包工厂</h1>
                        <p className="text-gray-500">快速制作微信表情包 · 本地处理保护隐私</p>
                    </header>

                    {/* Mode Switcher */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        {['static', 'dynamic', 'slice'].map(m => (
                            <button 
                                key={m}
                                onClick={() => { setMode(m); setRemoveWhiteBg(false); setItems([]); }} 
                                className={`p-4 rounded-3xl border-2 transition-all duration-300 flex items-center justify-center gap-3 group ${mode === m 
                                    ? `border-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-500 bg-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-50 text-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-700 shadow-md ring-2 ring-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-500 ring-offset-2` 
                                    : 'border-gray-200 bg-white text-gray-500 hover:border-gray-300 hover:bg-gray-50'}`}
                            >
                                <div className={`p-2 rounded-full ${mode === m ? `bg-${m==='static'?'green':m==='dynamic'?'purple':'blue'}-200` : 'bg-gray-100'}`}>
                                    {m === 'static' && <Icons.ImageIcon size={24} />}
                                    {m === 'dynamic' && <Icons.VideoIcon size={24} />}
                                    {m === 'slice' && <Icons.GridIcon size={24} />}
                                </div>
                                <div className="text-left">
                                    <div className="font-bold text-base">
                                        {m === 'static' ? '静态表情' : m === 'dynamic' ? '动态表情' : '切图(3x3/4x4)'}
                                    </div>
                                    <div className="text-[10px] opacity-70">
                                        {m === 'static' ? 'JPG / PNG' : m === 'dynamic' ? '视频转GIF' : '图片/视频 切割'}
                                    </div>
                                </div>
                            </button>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* 左侧控制区 */}
                        <div className="lg:col-span-4 space-y-6">
                            <div 
                                className={`border-4 border-dashed rounded-3xl bg-white p-8 text-center transition-all cursor-pointer group shadow-sm relative overflow-hidden border-gray-200 ${themeBorderHover}`}
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={handleDrop}
                                onClick={() => document.getElementById('fileInput').click()}
                            >
                                <input 
                                    type="file" 
                                    id="fileInput" 
                                    className="hidden" 
                                    accept={mode === 'static' ? "image/*" : (mode === 'dynamic' ? "video/*" : "image/*,video/*")} 
                                    multiple 
                                    onChange={(e) => {if(e.target.files) addFiles(e.target.files); e.target.value='';}} 
                                />
                                <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform ${themeIconBg}`}>
                                    {mode === 'static' && <Icons.Plus size={32} />}
                                    {mode === 'dynamic' && <Icons.VideoIcon size={32} />}
                                    {mode === 'slice' && <Icons.GridIcon size={32} />}
                                </div>
                                <h3 className="text-lg font-semibold text-gray-700 mb-1">
                                    {mode === 'slice' ? '点击添加素材(图/视频)' : `点击添加${mode === 'static' ? '图片' : '视频'}`}
                                </h3>
                                <p className="text-gray-400 text-xs">
                                    {mode === 'static' ? '支持批量 JPG, PNG, WEBP' : mode === 'dynamic' ? '支持 MP4, MOV' : '自动裁剪正方形并切图'}
                                </p>
                            </div>

                            <div className="bg-white rounded-3xl shadow-sm border border-gray-100 p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><Icons.Settings size={20} className="text-gray-400" />参数设置</h3>
                                </div>
                                <div className="space-y-6">
                                    
                                    {mode === 'slice' && (
                                        <div className="p-4 rounded-xl bg-blue-50 border border-blue-100">
                                            <div className="flex justify-between items-center mb-3">
                                                <div className="flex items-center gap-2 text-blue-800">
                                                    <Icons.GridIcon size={16} />
                                                    <h4 className="font-bold text-sm">自定义切片网格</h4>
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => { setSliceRows(3); setSliceCols(3); }} className={`text-[10px] px-2 py-1 border rounded transition-colors ${sliceRows===3 && sliceCols===3 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-blue-600 border-blue-200 hover:bg-blue-50'}`}>3x3</button>
                                                    <button onClick={() => { setSliceRows(4); setSliceCols(4); }} className={`text-[10px] px-2 py-1 border rounded transition-colors ${sliceRows===4 && sliceCols===4 ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-blue-600 border-blue-200 hover:bg-blue-50'}`}>4x4</button>
                                                </div>
                                            </div>
                                            <div className="space-y-4">
                                                <div className="space-y-1">
                                                    <div className="flex justify-between text-xs text-gray-500"><span>行数 (Rows)</span><span className="font-mono font-bold text-blue-600">{sliceRows}</span></div>
                                                    <input type="range" min="1" max="8" step="1" value={sliceRows} onChange={(e) => setSliceRows(parseInt(e.target.value))} className="w-full h-1 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                                </div>
                                                <div className="space-y-1">
                                                    <div className="flex justify-between text-xs text-gray-500"><span>列数 (Cols)</span><span className="font-mono font-bold text-blue-600">{sliceCols}</span></div>
                                                    <input type="range" min="1" max="8" step="1" value={sliceCols} onChange={(e) => setSliceCols(parseInt(e.target.value))} className="w-full h-1 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                                </div>
                                                <div className="text-[10px] text-blue-400 text-center pt-1 border-t border-blue-100">将生成 {sliceRows * sliceCols} 个文件</div>
                                            </div>
                                        </div>
                                    )}

                                    <div>
                                        <label className="block text-sm font-medium text-gray-600 mb-2">目标尺寸 (单张)</label>
                                        <div className="flex flex-wrap gap-2">
                                            {sizePresets.map(preset => (
                                                <button key={preset.label} onClick={() => setTargetSize({ w: preset.w, h: preset.h })} className={`py-2 px-3 rounded-xl text-xs font-medium border transition-all ${targetSize.w === preset.w && targetSize.h === preset.h ? `bg-${themeColor}-500 text-white border-${themeColor}-500 shadow-md` : 'bg-white text-gray-600 border-gray-200 hover:border-gray-300'}`}>{preset.label}</button>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-600 mb-2">背景处理</label>
                                        <div className="flex gap-2 mb-3">
                                            <button onClick={() => setPaddingColor('transparent')} className={`flex-1 py-2 rounded-xl text-xs font-medium border flex items-center justify-center gap-2 ${paddingColor === 'transparent' ? `ring-2 ring-${themeColor}-500 border-${themeColor}-500 bg-${themeColor}-50 text-${themeColor}-700` : 'border-gray-200'}`}><div className="w-3 h-3 rounded border bg-gray-100" style={{backgroundImage: 'linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)', backgroundSize: '4px 4px'}}></div>透明</button>
                                            <button onClick={() => setPaddingColor('white')} className={`flex-1 py-2 rounded-xl text-xs font-medium border flex items-center justify-center gap-2 ${paddingColor === 'white' ? `ring-2 ring-${themeColor}-500 border-${themeColor}-500 bg-white text-gray-900` : 'border-gray-200'}`}><div className="w-3 h-3 rounded border border-gray-300 bg-white"></div>白色</button>
                                            <label className={`flex-1 py-2 rounded-xl text-xs font-medium border flex items-center justify-center gap-2 cursor-pointer ${paddingColor !== 'transparent' && paddingColor !== 'white' ? `ring-2 ring-${themeColor}-500 border-${themeColor}-500 bg-white text-gray-900` : 'border-gray-200'}`}>
                                                <input type="color" className="opacity-0 w-0 h-0 absolute" value={paddingColor === 'transparent' ? '#ffffff' : paddingColor} onChange={(e) => setPaddingColor(e.target.value)} />
                                                <div className="w-3 h-3 rounded border border-gray-300" style={{backgroundColor: paddingColor !== 'transparent' ? paddingColor : 'transparent'}}></div>
                                                <span className="flex items-center gap-1"><Icons.Palette size={12}/>自定义</span>
                                            </label>
                                        </div>

                                        <div className={`p-3 rounded-xl border transition-colors ${removeWhiteBg ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-transparent'}`}>
                                            <div className="flex items-center justify-between">
                                                <label className="flex items-center gap-2 cursor-pointer select-none">
                                                    <div className={`w-5 h-5 rounded border flex items-center justify-center ${removeWhiteBg ? 'bg-blue-500 border-blue-500' : 'bg-white border-gray-300'}`}>{removeWhiteBg && <Icons.CheckCircle size={14} className="text-white" />}</div>
                                                    <input type="checkbox" className="hidden" checked={removeWhiteBg} onChange={(e) => setRemoveWhiteBg(e.target.checked)} />
                                                    <span className={`text-sm font-medium ${removeWhiteBg ? 'text-blue-700' : 'text-gray-600'}`}>去除白色背景</span>
                                                </label>
                                                <Icons.Wand2 size={16} className={`${removeWhiteBg ? 'text-blue-500' : 'text-gray-400'}`} />
                                            </div>
                                            {removeWhiteBg && (
                                                <div className="mt-2 pt-2 border-t border-blue-100">
                                                    <div className="flex justify-between text-xs text-blue-600 mb-1"><span>强度:弱</span><span>强</span></div>
                                                    <input type="range" min="1" max="100" value={bgTolerance} onChange={(e) => setBgTolerance(parseInt(e.target.value))} className="w-full h-1.5 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {(mode === 'dynamic' || mode === 'slice') && (
                                        <div className="space-y-4 p-4 rounded-xl bg-purple-50 border border-purple-100">
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-2 text-purple-800">
                                                    <Icons.Sliders size={16} />
                                                    <h4 className="font-bold text-sm">GIF 压缩设置</h4>
                                                </div>
                                                <div className="flex gap-1.5">
                                                    <button onClick={() => setGifConfig({fps: 8, quality: 10, duration: 3})} className={`text-[10px] px-2 py-1 border rounded transition-colors ${gifConfig.fps===8 ? 'bg-purple-600 text-white border-purple-600' : 'bg-white border-purple-200 text-purple-600'}`}>标准</button>
                                                    <button onClick={() => setGifConfig({fps: 5, quality: 10, duration: 3})} className={`text-[10px] px-2 py-1 border rounded transition-colors ${gifConfig.fps===5 ? 'bg-purple-600 text-white border-purple-600' : 'bg-white border-purple-200 text-purple-600'}`}>500K限制</button>
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-xs text-gray-500"><span>帧率</span><span className="text-purple-700">{gifConfig.fps} FPS</span></div>
                                                <input type="range" min="1" max="15" value={gifConfig.fps} onChange={(e) => setGifConfig({...gifConfig, fps: parseInt(e.target.value)})} className="w-full h-1 bg-purple-200 rounded-lg accent-purple-500" />
                                                <div className="flex justify-between text-xs text-gray-500"><span>时长</span><span className="text-purple-700">{gifConfig.duration}s</span></div>
                                                <input type="range" min="1" max="10" step="0.5" value={gifConfig.duration} onChange={(e) => setGifConfig({...gifConfig, duration: parseFloat(e.target.value)})} className="w-full h-1 bg-purple-200 rounded-lg accent-purple-500" />
                                            </div>
                                        </div>
                                    )}

                                    {items.length > 0 && (
                                        <div className="pt-4 border-t border-gray-100 space-y-3">
                                            <button onClick={downloadAllZip} disabled={isZipping} className={`w-full py-3 text-white rounded-xl font-bold shadow-md active:scale-95 transition-all flex items-center justify-center gap-2 ${isZipping ? 'bg-gray-400' : `bg-${themeColor}-600 hover:bg-${themeColor}-700`}`}>
                                                {isZipping ? <Icons.RefreshCw className="animate-spin" size={18}/> : <Icons.Package size={18} />}
                                                {isZipping ? '正在打包...' : `打包下载全部 (${items.length})`}
                                            </button>
                                            <button onClick={removeAll} className={`w-full py-2 rounded-xl text-sm font-medium flex items-center justify-center gap-2 transition-colors ${clearConfirm ? 'bg-red-500 text-white' : 'text-red-500 hover:bg-red-50'}`}>
                                                <Icons.Trash2 size={16} />{clearConfirm ? '确定清空？' : '清空列表'}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* 右侧结果区 */}
                        <div className="lg:col-span-8">
                            <div className="bg-white rounded-3xl shadow-lg border border-gray-100 p-6 min-h-[500px]">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className={`font-bold text-gray-800 flex items-center gap-2`}><Icons.FileImage size={20} className={`text-${themeColor}-500`}/>处理结果 ({items.length})</h3>
                                    {isGlobalProcessing && <span className={`text-sm flex items-center gap-2 animate-pulse text-${themeColor}-600`}><Icons.RefreshCw size={14} className="animate-spin"/>处理中...</span>}
                                </div>

                                {items.length > 0 ? (
                                    <div 
                                        className="grid gap-4"
                                        style={{ gridTemplateColumns: mode === 'slice' ? `repeat(${sliceCols}, minmax(0, 1fr))` : 'repeat(auto-fill, minmax(140px, 1fr))' }}
                                    >
                                        {items.map(item => (
                                            <div key={item.id} className="relative group bg-gray-50 rounded-xl border border-gray-200 p-3 hover:shadow-md transition-shadow">
                                                <button onClick={() => removeItem(item.id)} className="absolute top-2 right-2 z-10 p-1.5 bg-white text-gray-400 hover:text-red-500 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"><Icons.X size={14} /></button>
                                                <div className="bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPgo8cmVjdCB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSI0IiBoZWlnaHQ9IjQiIGZpbGw9IiNlNWU1ZTUiLz4KPHJlY3QgeD0iNCIgeT0iNCIgd2lkdGg9IjQiIGhlaWdodD0iNCIgZmlsbD0iI2U1ZTVlNSIvPgo8L3N2Zz4=')] rounded-lg overflow-hidden flex items-center justify-center mb-3 border border-gray-100 relative" style={{ aspectRatio: `${targetSize.w}/${targetSize.h}` }}>
                                                    {item.processedUrl ? (
                                                        <img src={item.processedUrl} alt="processed" className="max-w-full max-h-full object-contain" />
                                                    ) : (
                                                        <div className="flex flex-col items-center">
                                                            <Icons.RefreshCw className="animate-spin text-gray-400 mb-2" />
                                                            <span className="text-xs text-gray-400">{item.type==='video'?'转换中...':'处理中...'}</span>
                                                        </div>
                                                    )}
                                                    {/* GIF/Video Badges and Overlay Buttons */}
                                                    {item.type === 'video' && item.processedUrl && (
                                                        <>
                                                            <div className="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-1 rounded">GIF</div>
                                                            {/* Smart Compress Button if size > 500KB */}
                                                            {item.size > 500 * 1024 && (
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); compressItem(item.id); }}
                                                                    className="absolute top-1 left-1 bg-red-500 hover:bg-red-600 text-white text-[10px] px-2 py-1 rounded shadow-sm flex items-center gap-1 transition-colors"
                                                                    title="文件过大，点击一键优化到 500KB 以下"
                                                                >
                                                                    <Icons.Compress size={10} />
                                                                    压缩
                                                                </button>
                                                            )}
                                                        </>
                                                    )}
                                                    {mode === 'slice' && item.name.match(/_(\d+)\.(png|gif)$/) && (
                                                        <div className="absolute top-1 left-1 bg-blue-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold shadow-sm">
                                                            {item.name.match(/_(\d+)\.(png|gif)$/)[1]}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="space-y-1">
                                                    <div className="flex justify-between items-center text-xs text-gray-500">
                                                        <span className="truncate max-w-[80px]" title={item.name}>{item.name}</span>
                                                        <span className={`${item.size > 500 * 1024 ? 'text-red-500 font-bold' : `text-${themeColor}-600`}`}>{formatSize(item.size)}</span>
                                                    </div>
                                                    <button onClick={() => downloadItem(item)} disabled={!item.processedUrl} className="w-full mt-2 py-1.5 bg-white border border-gray-200 hover:border-green-500 hover:text-green-600 text-gray-600 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1"><Icons.Download size={12} />下载</button>
                                                </div>
                                            </div>
                                        ))}
                                        {mode !== 'slice' && (
                                            <div onClick={() => document.getElementById('fileInput').click()} className={`border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-400 transition-colors cursor-pointer min-h-[160px] hover:bg-gray-50 hover:border-${themeColor}-400 hover:text-${themeColor}-500`}><Icons.Plus size={24} className="mb-2" /><span className="text-sm font-medium">继续添加</span></div>
                                        )}
                                    </div>
                                ) : (
                                    /* Empty State */
                                    mode === 'slice' ? (
                                        <div className="h-full flex flex-col items-center justify-center p-8 text-gray-300 border-2 border-dashed border-gray-100 rounded-2xl min-h-[500px]">
                                             <div 
                                                className="grid gap-2 w-full max-w-md aspect-square"
                                                style={{ 
                                                    gridTemplateColumns: `repeat(${sliceCols}, minmax(0, 1fr))`,
                                                    gridTemplateRows: `repeat(${sliceRows}, minmax(0, 1fr))`
                                                }}
                                             >
                                                {Array.from({ length: sliceRows * sliceCols }).map((_, i) => (
                                                    <div 
                                                        key={i} 
                                                        onClick={() => document.getElementById('fileInput').click()}
                                                        className="border-2 border-dashed border-gray-200 rounded-lg bg-gray-50 flex items-center justify-center hover:border-blue-400 hover:bg-blue-50 transition-colors cursor-pointer"
                                                    >
                                                        <span className="text-xs text-gray-300 font-mono">{i + 1}</span>
                                                    </div>
                                                ))}
                                             </div>
                                             <p className="text-sm mt-6 text-gray-400">点击任意格子上传素材，自动切分为 {sliceRows}x{sliceCols}</p>
                                        </div>
                                    ) : (
                                        <div className="h-64 flex flex-col items-center justify-center text-gray-300 border-2 border-dashed border-gray-100 rounded-2xl">
                                            <p className="text-sm">暂无素材，请在左侧添加</p>
                                        </div>
                                    )
                                )}
                            </div>
                        </div>
                    </div>

                    <footer className="mt-16 pt-8 border-t border-gray-200">
                        <div className="flex flex-col md:flex-row justify-center items-center gap-8 text-center md:text-left">
                            <div className="flex flex-col items-center gap-2">
                                <div className="w-32 h-32 bg-white rounded-xl flex items-center justify-center border border-gray-200 overflow-hidden shadow-sm">
                                    <img src="zanshang.png" alt="赞赏二维码" className="w-full h-full object-contain" onError={(e) => { e.target.style.display = 'none'; e.target.parentNode.classList.add('bg-gray-50'); e.target.parentNode.innerHTML = '<div class="flex flex-col items-center gap-1 text-gray-300"><span class="text-[10px]">zanshang.png</span></div>'; }} />
                                </div>
                                <span className="text-sm font-bold text-gray-600 flex items-center gap-1"><Icons.Heart size={14} className="text-pink-500 fill-pink-500"/> 赞赏作者</span>
                            </div>
                            <div className="flex flex-col items-center gap-2">
                                <div className="w-32 h-32 bg-white rounded-xl flex items-center justify-center border border-gray-200 overflow-hidden shadow-sm">
                                    <img src="add.png" alt="添加作者" className="w-full h-full object-contain" onError={(e) => { e.target.style.display = 'none'; e.target.parentNode.classList.add('bg-gray-50'); e.target.parentNode.innerHTML = '<div class="flex flex-col items-center gap-1 text-gray-300"><span class="text-[10px]">add.png</span></div>'; }} />
                                </div>
                                <span className="text-sm font-bold text-gray-600 flex items-center gap-1"><Icons.UserPlus size={14} className="text-blue-500"/> 添加作者</span>
                            </div>
                        </div>
                        <div className="mt-8 text-center text-gray-400 text-xs">
                            <p>本工具纯前端运行，您的图片不会上传到任何服务器。</p>
                        </div>
                    </footer>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
